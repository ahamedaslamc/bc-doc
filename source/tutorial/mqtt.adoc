= MQTT â€“ Message transfer protocol
:imagesdir: images

== MQTT Basics

- Simple, Lightweight and open message protocol.
- Each message consists of *topic* and *payload*.
- Topic is describing the meaning of the data in payload.
  Topic uses tree-like structure with `/` symbol.
  Example topics: `bedroom/temperature`, `kitchen/light/set`.
- MQTT server is called *Broker* and clients can *publish* messages and *subscribe* to different types of topics.
- In subscribe topics the wildcard `+` can be used for single level subscription and symbol `&num;` for multi level subscription.
  Symbol `&num;` can be used only at the end of subscribed topic.
  http://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices[More on topics]


== Mosquitto MQTT broker

BigClown uses open-source https://mosquitto.org/[Mosquitto] broker which is running inside Docker.

To test MQTT and see the sent messages you can subscribe to topic with:

[source]
docker exec hub mosquitto_sub -v -t 'nodes/bridge/0/&num;'

If you would like to connect from outside of the docker or from different machine, you can remove the `docker exec hub` and add `-h <ip/host>` parameter of the address of running broker.

To publish a message use *mosquitto_pub* command:

[source]
docker exec hub mosquitto_pub -t nodes/bridge/0/relay/i2c0-3b/set -m '{"state": true}'


== Mosquitto configuration

You can edit Mosquitto settings in the configuration file which is located in `/etc/mosquitto/mosquitto.conf` inside the Docker.


=== MQTT Bridge

Bridging two MQTT servers together is useful for example when you would like interconnect MQTT broker inside Docker container with MQTT broker in Raspbian.

You have to install MQTT broker (for example same Mosquitto can be used) which you bridge with your Clown.Hub MQTT broker.
In this use case your Clown.Hub MQTT broker will connect to your MQTT broker in Raspbian.
So you have to configure your Cown.Hub MQTT broker with commands below.

[source]
----
# Bridge to host (Raspbian) MQTT broker
connection RaspbianMQTT
# Default IP address of Docker host network interface
address 172.17.0.1

# Optional authorization for Raspbian MQTT broker
remote_username clownhub
remote_password clownhub

#topic <topic> [[[out | in | both] qos-level] local-prefix remote-prefix]
topic # in 0 /home/# /home_remote/#
----

Topic command will subscribe to all topics (`topic &num;`) on Raspbian MQTT broker under `/home_remote/&num;` and will publish them on Clown.Hub MQTT broker under `/home/&num;`.
Parameter `in` describes direction and zero `0` means MQTT QoS 0.

WARNING: Do not interconnect Clown.Hub Docker container MQTT broker with outside/Internet MQTT brokers without extra integrity, authentication, authorization & privacy configuration for transport and destination environment (TLS, certificates, firewalls, etc.).

== GUI Tool Eclipse Paho mqtt-spy

For debugging and diagnostic purposes, you can use a tool with graphical user interface - https://github.com/eclipse/paho.mqtt-spy[Eclipse Paho mqtt-spy].

NOTE: This tool needs JRE 8 to be installed on the host machine.

- For more information about this tool, see: +
  https://github.com/eclipse/paho.mqtt-spy/wiki
- Follow this link to download the tool: +
  https://github.com/eclipse/paho.mqtt-spy/wiki/Downloads

After installation connect to your MQTT's broker IP address and subscribe to topics or start publishing messages.

TIP: This tool support subscription scripts written in JavaScript. You can automate your tasks with this feature.

image::mqtt-spy.png[Screenshot of mqtt-spy connected to the broker]
