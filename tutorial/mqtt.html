<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>MQTT – Message transfer protocol</title>

    <link href="/stylesheets/main.css" rel="stylesheet" />
  </head>

  <body>
    <header>
  <a href="https://www.bigclown.com/">
    <img src="/images/bigclown-logo.svg" alt="BigClown - Open-Source Electronics" class="header-logo" />
  </a>
</header>


    <input type="checkbox" id="navbar-toggle" role="button" />
<label for="navbar-toggle">
  <span class="icon-burger"></span>
</label>

<nav class="navbar">
  <ul>
  <li class="level0">
    <a href="/">Main page</a>
  </li>
  <li class="level1">
    <a href="/alpha/">ALPHA SET</a>
      <ul>
  <li class="level2">
    <a href="/alpha/macos.html">Software setup for macOS</a>
  </li>
  <li class="level2">
    <a href="/alpha/raspberry-pi.html">Software setup for Raspberry Pi</a>
  </li>
  <li class="level2">
    <a href="/alpha/ubuntu.html">Software setup for Ubuntu</a>
  </li>
  <li class="level2">
    <a href="/alpha/windows.html">Software setup for Windows</a>
  </li>
</ul>

  </li>
  <li class="level1">
    <a href="/tutorial/">Tutorials</a>
      <ul>
  <li class="level2">
    <a href="/tutorial/blynk.html">Blynk integration</a>
  </li>
  <li class="level2">
    <a href="/tutorial/mqtt.html" class="current">MQTT – Message transfer protocol</a>
  </li>
</ul>

  </li>
</ul>

</nav>


    <div id="main-wrapper">
      <div class="toolbar">
  <ul class="toolbar-actions">
    <li>
      <a href="https://github.com/bigclownlabs/bc-doc/edit/master/source/tutorial/mqtt.adoc" rel="external" title="Edit on GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon">
        <use xlink:href="#icon-pencil" />
      </svg>

        <span class="icon-label">Improve this page</span>
      </a>
    </li>
  </ul>
</div>


      <article class="main-content tutorial tutorial_mqtt">
        <h1>
          MQTT – Message transfer protocol
        </h1>
        <div class="sect1">
<h2 id="_mqtt_basics">MQTT Basics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Simple, Lightweight and open message protocol.</p>
</li>
<li>
<p>Each message consists of <strong>topic</strong> and <strong>payload</strong>.</p>
</li>
<li>
<p>Topic is describing the meaning of the data in payload.
Topic uses tree-like structure with <code>/</code> symbol.
Example topics: <code>bedroom/temperature</code>, <code>kitchen/light/set</code>.</p>
</li>
<li>
<p>MQTT server is called <strong>Broker</strong> and clients can <strong>publish</strong> messages and <strong>subscribe</strong> to different types of topics.</p>
</li>
<li>
<p>In subscribe topics the wildcard <code>+</code> can be used for single level subscription and symbol <code>&num;</code> for multi level subscription.
Symbol <code>&num;</code> can be used only at the end of subscribed topic.
<a href="http://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices">More on topics</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mosquitto_mqtt_broker">Mosquitto MQTT broker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BigClown uses open-source <a href="https://mosquitto.org/">Mosquitto</a> broker which is running inside Docker.</p>
</div>
<div class="paragraph">
<p>To test MQTT and see the sent messages you can subscribe to topic with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">docker exec hub mosquitto_sub -v -t 'nodes/bridge/0/#'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you would like to connect from outside of the docker or from different machine, you can remove the <code>docker exec hub</code> and add <code>-h &lt;ip/host&gt;</code> parameter of the address of running broker.</p>
</div>
<div class="paragraph">
<p>To publish a message use <strong>mosquitto_pub</strong> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">docker exec hub mosquitto_pub -t nodes/bridge/0/relay/i2c0-3b/set -m '{&quot;state&quot;: true}'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mosquitto_configuration">Mosquitto configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can edit Mosquitto settings in the configuration file which is located in <code>/etc/mosquitto/mosquitto.conf</code> inside the Docker.</p>
</div>
<div class="sect2">
<h3 id="_mqtt_bridge">MQTT Bridge</h3>
<div class="paragraph">
<p>Bridging two MQTT servers together is useful for example when you have your local MQTT server behind NAT and you would like to publish messages from the outside/Internet.
You have to create public MQTT server (for example on AWS server) which you bridge with your home MQTT server.
In this use case your local server will connect to your public server in AWS.
So you have to configure your local server with commands below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># Bridge to AWS
connection aws
address your.server.com

# Optional password, you should also use TLS to protect credentials
remote_username root
remote_password root

#topic &lt;topic&gt; [[[out | in | both] qos-level] local-prefix remote-prefix]
topic # in 0 /home/# /home_remote/#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Topic command will subscribe to all topics (<code>topic &num;</code>) on remote server under <code>/home_remote/&num;</code> and will publish them on local server under <code>/home/#</code>.
Parameter <code>in</code> describes direction and zero <code>0</code> means no QoS.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gui_tool_eclipse_paho_mqtt_spy">GUI Tool Eclipse Paho mqtt-spy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For debugging and diagnostic purposes, you can use a tool with graphical user interface - <a href="https://github.com/eclipse/paho.mqtt-spy">Eclipse Paho mqtt-spy</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This tool needs JRE 8 to be installed on the host machine.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about this tool, see:<br>
<a href="https://github.com/eclipse/paho.mqtt-spy/wiki" class="bare">https://github.com/eclipse/paho.mqtt-spy/wiki</a></p>
</li>
<li>
<p>Follow this link to download the tool:<br>
<a href="https://github.com/eclipse/paho.mqtt-spy/wiki/Downloads" class="bare">https://github.com/eclipse/paho.mqtt-spy/wiki/Downloads</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After installation connect to your MQTT&#8217;s broker IP address and subscribe to topics or start publishing messages.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This tool support subscription scripts written in JavaScript. You can automate your tasks with this feature.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/mqtt-spy.png" alt="Screenshot of mqtt-spy connected to the broker">
</div>
</div>
</div>
</div>
      </article>

      <footer>
  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
</footer>

    </div>

    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     version="1.1"
     style="position: absolute; width: 0; height: 0; overflow: hidden;">
  <defs>
    <symbol id="icon-pencil" viewBox="0 0 28 32">
      <title>pencil</title>
      <path d="M22 2l-4 4 6 6 4-4-6-6zM0 24l0.021 6.018 5.979-0.018 16-16-6-6-16 16zM6 28h-4v-4h2v2h2v2z"/>
    </symbol>
  </defs>
</svg>

  </body>
</html>
